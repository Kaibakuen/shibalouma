<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢é€” AI æ—…ä¼´ - å°é˜¿å®¢</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        /* ä½¿ç”¨ Inter å­—é«” */
        :root { font-family: 'Inter', sans-serif; }
        
        /* æ ¸å¿ƒä¸»é¡Œè‰²å®šç¾© */
        .color-primary { background-color: #103561; } /* æ·±è—è‰² */
        .color-secondary { background-color: #1a4270; } /* ç¨æ·ºçš„è—è‰² */
        .color-accent { background-color: #f59e0b; } /* æ©™è‰² */
        .text-accent { color: #f59e0b; }
        
        body { 
            background-color: #0d284a; 
            min-height: 100vh;
        }

        /* --- è½‰å ´å‹•ç•«å®šç¾© --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* ------------------------ */
        /* SPLASH SCREEN æ¨£å¼ */
        /* ------------------------ */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #103561; /* æ·±è—è‰²èƒŒæ™¯ */
            color: white;
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }
        #splash-video-container {
            width: 90%;
            max-width: 300px;
            margin-bottom: 2rem;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        #splash-video {
            display: block;
            width: 100%;
            height: auto;
        }
        
        /* ------------------------ */
        /* ä¸» APP æ¨£å¼ (èŠå¤©ä»‹é¢) */
        /* ------------------------ */
        #app-container {
            min-height: 100vh;
            display: none; /* é è¨­éš±è—ï¼Œç­‰å¾…Splash ScreençµæŸ */
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        #chat-window {
            background-color: #ffffff;
            max-width: 1000px;
            width: 100%;
            height: 90vh; 
            max-height: 800px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            display: flex;
            flex-direction: row; 
        }
        
        /* å´é‚Šæ¬„å’Œå‰ç¥¥ç‰©å®¹å™¨ */
        #sidebar {
            width: 300px;
            display: none; 
            padding: 2rem;
            color: white;
            flex-direction: column;
            justify-content: space-between;
        }

        /* èŠå¤©ä¸»é«” */
        #chat-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #f7f7f7; 
        }
        
        /* èŠå¤©å…§å®¹å€ */
        #messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: #f7f7f7;
        }

        /* è¦†è“‹è¨Šæ¯æ³¡æ³¡æ¨£å¼ */
        .bot-message, .user-message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 0.95rem;
        }
        .bot-message {
            background-color: #e2e8f0; 
            color: #103561; 
            border-radius: 15px 15px 15px 5px;
        }
        .user-message {
            background-color: #fde68a; 
            color: #103561; 
            border-radius: 15px 15px 5px 15px;
        }
        .flex-card {
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* éŸ¿æ‡‰å¼ä½ˆå±€èª¿æ•´ */
        @media (min-width: 768px) {
            #sidebar {
                display: flex;
            }
        }
        
        /* å‰ç¥¥ç‰©å½±ç‰‡èª¿æ•´ */
        #mascot-video {
            width: 100%;
            height: auto;
            max-height: 250px; 
            object-fit: cover;
            border-radius: 8px;
        }
        /* éš±è—åŸç”Ÿ video æ§ä»¶ */
        #splash-video::-webkit-media-controls,
        #mascot-video::-webkit-media-controls { display: none !important; }
        #splash-video,
        #mascot-video { pointer-events: none; }
    </style>
</head>
<body class="p-0 flex flex-col items-center justify-center min-h-screen">
    
    <!-- 1. SPLASH SCREEN (èµ·å§‹ç•«é¢) -->
    <div id="splash-screen">
        <h1 class="text-4xl font-extrabold mb-4 animate-pulse">å®¢é€” AI æ—…ä¼´</h1>
        <p class="text-lg opacity-80 mb-8">å°ä¸‰ç·šå®¢åº„ç”Ÿæ…‹åšç‰©é¤¨</p>

        <div id="splash-video-container">
            <!-- å‰ç¥¥ç‰©æ®æ‰‹å½±ç‰‡ -->
            <video id="splash-video" autoplay loop muted playsinline>
                <source src="asset/video/1213.mp4" type="video/mp4">
                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
            </video>
        </div>

        <button id="start-button" 
                class="color-accent hover:bg-amber-600 text-white text-xl font-bold px-8 py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
            <i data-lucide="play" class="w-5 h-5 inline-block mr-2"></i> é»æˆ‘é–‹å§‹æ—…ç¨‹
        </button>
    </div>

    <!-- 2. MAIN APPLICATION CONTAINER (ä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢) -->
    <div id="app-container" class="w-full">
        <div id="chat-window">
            
            <!-- å´é‚Šæ¬„ (Sidebar) - è¦–è¦ºèˆ‡å‰ç¥¥ç‰© -->
            <div id="sidebar" class="color-primary p-6">
                <div>
                    <h2 class="text-2xl font-extrabold mb-4 border-b pb-2 border-white/50">å°é˜¿å®¢ AI æ—…ä¼´</h2>
                    <p class="text-sm opacity-80 mb-6">å°ä¸‰ç·šå®¢åº„ç”Ÿæ…‹åšç‰©é¤¨ï¼Œå°ˆå±¬çš„å€‹äººåŒ–è¡Œç¨‹è¦åŠƒæœå‹™ã€‚</p>
                    
                    <div class="mb-6">
                        <div class="font-semibold text-accent mb-2">æ‚¨çš„ ID è³‡è¨Š</div>
                        <div id="user-id-display" class="text-xs break-all bg-white/10 p-2 rounded-lg">
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
                
                <!-- å‰ç¥¥ç‰©å‹•ç•« (å½±ç‰‡ï¼Œé‡è¤‡ä¸€æ¬¡ï¼Œç¢ºä¿èˆ‡splash videoä¸åŒID) -->
                <div class="text-center">
                    <p class="text-xs opacity-70 mb-2">å‰ç¥¥ç‰©ï¼šå°é˜¿å®¢</p>
                    <video id="mascot-video" autoplay loop muted playsinline>
                        <source src="asset/video/1213.mp4" type="video/mp4">
                        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ¨™ç±¤ã€‚
                    </video>
                </div>
            </div>

            <!-- èŠå¤©ä¸»é«” (Chat Main) -->
            <div id="chat-main">
                <!-- Chat Header -->
                <div class="p-4 bg-white text-gray-800 shadow-md flex items-center justify-center border-b border-gray-200">
                    <h1 class="text-xl font-bold flex items-center">
                        <i data-lucide="route" class="w-5 h-5 mr-2 text-accent"></i> å®¢è£½åŒ–è¡Œç¨‹è¦åŠƒ
                    </h1>
                </div>

                <!-- Messages Container -->
                <div id="messages" class="space-y-4">
                    <!-- Initial Message Placeholder -->
                </div>

                <!-- Input Area (Rich Menu & Text Input Simulation) -->
                <div id="input-area" class="p-4 bg-white border-t border-gray-200">
                    <!-- å¿«é€ŸæŒ‰éˆ•å€ (Rich Menu Simulation) -->
                    <div id="rich-menu-sim" class="flex justify-center space-x-3 mb-4">
                        <button onclick="handleMessage('æˆ‘æƒ³è¦åŠƒè¡Œç¨‹')" class="bg-blue-700 hover:bg-blue-800 text-white text-xs px-4 py-2 rounded-full shadow-md transition duration-200 flex items-center">
                            <i data-lucide="map-pin" class="w-3 h-3 inline-block mr-1"></i> ç›´æ¥è¦åŠƒ
                        </button>
                        <button onclick="handleMessage('é‡æ–°æ¸¬é©—')" class="color-accent hover:bg-amber-600 text-white text-xs px-4 py-2 rounded-full shadow-md transition duration-200 flex items-center">
                            <i data-lucide="list-checks" class="w-3 h-3 inline-block mr-1"></i> é–‹å§‹å•å·
                        </button>
                        <a href="https://example.com/AR_App_Download" target="_blank" class="bg-gray-400 hover:bg-gray-500 text-white text-xs px-4 py-2 rounded-full shadow-md transition duration-200 flex items-center">
                            <i data-lucide="link" class="w-3 h-3 inline-block mr-1"></i> å¤–éƒ¨é€£çµ
                        </a>
                    </div>
                    <!-- æ–‡å­—è¼¸å…¥æ¡† -->
                    <div class="flex">
                        <input type="text" id="user-input" placeholder="è¼¸å…¥éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæ–°ç«¹å³¨çœ‰ï¼Œæˆ¶å¤–æ´»å‹• æˆ– ä»€éº¼æ˜¯å®¢å®¶æ“‚èŒ¶?" class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-accent focus:border-accent focus:outline-none transition duration-150" onkeyup="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" class="color-primary hover:bg-blue-800 text-white px-4 rounded-r-lg shadow-md transition duration-200">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥æ ¸å¿ƒé‚è¼¯ (ä½¿ç”¨æ¨™æº– script æ¨™ç±¤è§£æ±º lucide éŒ¯èª¤) -->
    <script>
        // --- æ ¸å¿ƒæ•¸æ“šçµæ§‹ (ç”¨æ–¼å„²å­˜ç”¨æˆ¶ç‹€æ…‹èˆ‡åå¥½å‘é‡) ---

        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const userIdDisplay = document.getElementById('user-id-display');

        // æ—…éŠåå¥½ç¶­åº¦
        const PREFERENCE_DIMENSIONS = {
            "Culture": 0, "Outdoor": 0, "Pace": 0, "LowCarbon": 0,
            "Family": 0, "Accessibility": 0, "CultureDepth": 0,
            "Indoor": 0, "RiskAversion": 0
        };

        // ç‹€æ…‹ç®¡ç†
        let currentPreferences = { ...PREFERENCE_DIMENSIONS }; // Global state for preferences
        let currentQuizStep = 0; // Global state for quiz step

        // --- Local Storage Ops (æœ¬åœ°å„²å­˜å–ä»£ Firebase) ---

        function generateAnonUserId() {
            // æ¨¡æ“¬ä¸€å€‹åŒ¿å UIDï¼Œç”¨æ–¼é¡¯ç¤ºå’Œæœ¬åœ°å„²å­˜çš„éµ
            return 'anon_' + Math.random().toString(36).substring(2, 15);
        }

        function loadStateFromLocalStorage() {
            try {
                const storedState = localStorage.getItem('hakka_quiz_state');
                if (storedState) {
                    const data = JSON.parse(storedState);
                    currentPreferences = data.preferences || { ...PREFERENCE_DIMENSIONS };
                    currentQuizStep = data.quiz_step || 0;
                    return true;
                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
            }
            return false;
        }

        function saveStateToLocalStorage() {
            try {
                const stateToSave = {
                    preferences: currentPreferences,
                    quiz_step: currentQuizStep,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('hakka_quiz_state', JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        }
        
        function updatePreferenceVector(valString) {
            (valString || "").split(',').forEach(item => {
                if (!item) return;
                const matches = item.match(/([+-]\d+)([A-Za-z]+)/);
                if (matches && matches.length === 3) {
                    const val = parseInt(matches[1]);
                    const dim = matches[2];
                    if (dim in currentPreferences) {
                        currentPreferences[dim] += val;
                    }
                }
            });
        }
        
        // --- 2. æ¸¬é©—æ•¸æ“šèˆ‡è¡Œç¨‹æ•¸æ“š ---
        
        // å°ä¸‰ç·šæ™¯é»è³‡æ–™åº« (çœŸå¯¦æ™¯é»ï¼Œæ¨¡æ“¬ Google Maps é€£çµ)
        const HAKKA_ATTRACTIONS = [
            { id: 1, region: "æ¡ƒåœ’", name: "å¤§æºªè€è¡— (Daxi Old Street)", theme: ["Culture", "Indoor", "Pace"], description: "å……æ»¿å·´æ´›å…‹å¼ç«‹é¢å»ºç¯‰çš„æ­·å²è¡—å€ï¼Œé©åˆå®¤å…§æ–‡åŒ–æ¢ç´¢èˆ‡æ…¢æ­¥èª¿ã€‚", map_url: "https://maps.app.goo.gl/yQ9fQ7k7yJ6eLg9v9" },
            { id: 2, region: "æ–°ç«¹", name: "åŒ—åŸ”è€è¡—/é‡‘å»£ç¦å…¬é¤¨", theme: ["Culture", "CultureDepth", "Indoor"], description: "åŒ—å°ç£å®¢å®¶æ–‡åŒ–çš„ä¸­å¿ƒï¼Œå¿…åšæ“‚èŒ¶ï¼Œé©åˆæ–‡å²æ„›å¥½è€…æ·±åº¦æ¢ç´¢ã€‚", map_url: "https://maps.app.goo.gl/6E6oN2hV1r9XJz3f7" },
            { id: 3, region: "æ–°ç«¹", name: "å³¨çœ‰æ¹–/ç´°èŒ…åŸ”åŠæ©‹", theme: ["Outdoor", "LowCarbon", "Pace"], description: "æ¹–ç•”æ­¥é“èˆ‡ç”Ÿæ…‹æ™¯è§€ï¼Œé©åˆæˆ¶å¤–ã€é¨å–®è»Šçš„ä½ç¢³æ…¢æ´»è·¯ç·šã€‚", map_url: "https://maps.app.goo.gl/DkK8Z7yB7N8xT6rD7" },
            { id: 4, region: "è‹—æ —", name: "ç…é ­å±±é¢¨æ™¯å€", theme: ["Outdoor", "CultureDepth", "RiskAversion"], description: "å¥è¡Œæ­¥é“èˆ‡å¤é“æ–‡åŒ–ï¼Œæ˜¯æŒ‘æˆ°å‹çš„æˆ¶å¤–ç™»å±±å¥è¡Œé¦–é¸ã€‚", map_url: "https://maps.app.goo.gl/yP7jXg4Z1b6hC5rP9" },
            { id: 5, region: "è‹—æ —", name: "å—åº„è€è¡— (æ¡‚èŠ±å··)", theme: ["Culture", "Indoor", "Family"], description: "è¼•é¬†é€›è¡—ã€å“åšå®¢å®¶å°åƒï¼Œå…·å‚™è¦ªå­å‹å–„è¨­æ–½ã€‚", map_url: "https://maps.app.goo.gl/wU2aD6yZ9k7qL5xK8" },
            { id: 6, region: "å°ä¸­", name: "æ±å‹¢å®¢å®¶æ–‡åŒ–åœ’å€ (è‡ªè¡Œè»Šé“)", theme: ["LowCarbon", "Outdoor", "Pace"], description: "èˆŠç«è»Šç«™æ”¹å»ºï¼Œçµåˆéµé“æ–‡åŒ–èˆ‡ç¶ è‰²å»Šé“ï¼Œæ˜¯å–®è»Šæ´»å‹•çš„æœ€ä½³èµ·é»ã€‚", map_url: "https://maps.app.goo.gl/Gj8xN4bY5rE2pA3c6" }
        ];

        // 10 é¡Œæ—…éŠåå¥½å•å·åŠå…¶å‘é‡æ¬Šé‡
        const QUIZ_QUESTIONS = {
            1: {
                "text": "Q1: æ—…ç¨‹è¦åŠƒæ™‚ï¼Œæ¯”èµ·èŠå¤©ï¼Œæ‚¨æ›´å–œæ­¡å®‰éœåšè‡ªå·±çš„äº‹å—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œæˆ‘éœ€è¦æ™‚é–“ç¨è‡ªæ²‰æ¾±æˆ–æ€è€ƒ", val: "+3Indoor,+2Pace,-1Outdoor" },
                    { label: "B: å¦ï¼Œæˆ‘å–œæ­¡èˆ‡æ—…ä¼´è¨è«–ï¼Œå…±åŒæ±ºå®š", val: "+3Outdoor,-1Indoor,-2Pace" },
                ]
            },
            2: {
                "text": "Q2: æ‚¨è¦ºå¾—èƒ½ç¡é£½ï¼Œæ¯”æ—©èµ·è¶•è¡Œç¨‹ã€çœ‹ç¾æ™¯æ›´é‡è¦å—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œä¼‘æ¯æ˜¯æ—…è¡Œçš„é‡é»", val: "+3Pace,+2Indoor,-2Outdoor" },
                    { label: "B: å¦ï¼Œæˆ‘é¡˜æ„æ—©èµ·æŠŠæ¡æ™‚é–“å¤šç©ä¸€é»", val: "-3Pace,+2Outdoor,+2RiskAversion" },
                ]
            },
            3: {
                "text": "Q3: åœ¨äººå¤šç†±é¬§çš„è€è¡—æˆ–èšæœƒå ´æ‰€ï¼Œæ‚¨æœƒæ„Ÿåˆ°æ´»åŠ›å……æ²›å—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œæˆ‘äº«å—ç¤¾äº¤å’Œäººç¾¤çš„ç†±é¬§", val: "-3Indoor,+2Culture,-1Pace" },
                    { label: "B: å¦ï¼Œæˆ‘æ›´å–œæ­¡å®‰éœçš„è‡ªç„¶æˆ–æ­·å²æ™¯é»", val: "+3Indoor,+2Pace,-2Culture" },
                ]
            },
            4: {
                "text": "Q4: æ‚¨å°ä½å®¿ç’°å¢ƒæœ‰æ½”ç™–ï¼Œæˆ–æ˜¯åœ¨æ„èˆ’é©åº¦å—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œä½å®¿çš„å“è³ªæœƒå½±éŸ¿æˆ‘çš„å¿ƒæƒ…", val: "+3Indoor,+2RiskAversion,-1LowCarbon" },
                    { label: "B: å¦ï¼Œåªè¦æœ‰åŸºæœ¬åŠŸèƒ½ï¼Œä¾¿å®œå³å¯", val: "-3Indoor,-2RiskAversion,+1LowCarbon" },
                ]
            },
            5: {
                "text": "Q5: æ‚¨å–œæ­¡èµ°è·¯ï¼Œé•·æ™‚é–“çš„å¾’æ­¥æ¢ç´¢ä¸æ˜¯å•é¡Œå—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œæˆ‘å–œæ­¡ç”¨é›™è…³æ·±åº¦æ¢ç´¢", val: "+4Outdoor,+3LowCarbon,+2CultureDepth" },
                    { label: "B: å¦ï¼Œæˆ‘åå¥½æ­ä¹˜äº¤é€šå·¥å…·æˆ–çŸ­ç¨‹ç§»å‹•", val: "-3Outdoor,-2LowCarbon,+2Pace" },
                ]
            },
            6: {
                "text": "Q6: è¦åŠƒè¡Œç¨‹æ™‚ï¼Œæ‚¨æœƒå…ˆè€ƒé‡æ˜¯å¦æœ‰å…’ç«¥æˆ–é•·è€…å‹å–„è¨­æ–½å—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œæ‰€æœ‰äººçš„èˆ’é©åº¦æ˜¯æˆ‘çš„é¦–è¦è€ƒé‡", val: "+4Family,+4Accessibility,+2RiskAversion" },
                    { label: "B: å¦ï¼Œæˆ‘ä»¥æ™¯é»çš„ç¨ç‰¹æ€§å’Œå€‹äººèˆˆè¶£ç‚ºä¸»", val: "-3Family,-3Accessibility,-1RiskAversion" },
                ]
            },
            7: {
                "text": "Q7: æ—…ç¨‹ä¸­é‡åˆ°çªç™¼ç‹€æ³ï¼Œæ‚¨å‚¾å‘ç«‹å³å•Ÿå‹•å‚™ç”¨æ–¹æ¡ˆï¼Œé¿å…ä»»ä½•é¢¨éšªå—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œæˆ‘è¨å­è¡Œç¨‹è¢«æ‰“äº‚", val: "+4RiskAversion,+2Indoor,-2Pace" },
                    { label: "B: å¦ï¼Œæˆ‘é¡˜æ„éš¨æ©Ÿæ‡‰è®Šï¼Œç”šè‡³æ¥å—æ„å¤–çš„é©šå–œ", val: "-4RiskAversion,+2Outdoor,+2Pace" },
                ]
            },
            8: {
                "text": "Q8: æ‚¨æœƒè¨­å®šæ—…ç¨‹é ç®—ä¸¦ä¸”å¯¦éš›æ§ç®¡ï¼Œæ¨ä¸å¾—èŠ±å¤ªå¤šéŒ¢äº«å—ç¾é£Ÿå—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œæ§åˆ¶é ç®—æ¯”ç¾é£Ÿäº«å—é‡è¦", val: "+3LowCarbon,-3Indoor" },
                    { label: "B: å¦ï¼Œæˆ‘è »æ¨å¾—èŠ±éŒ¢äº«å—ç¾é£Ÿçš„", val: "-3LowCarbon,+3Indoor" },
                ]
            },
            9: {
                "text": "Q9: å“ªç¨®å®¢åº„é«”é©—å°æ‚¨æ›´æœ‰å¸å¼•åŠ›ï¼Ÿ",
                "options": [
                    { label: "A: åƒè§€å®¢å®¶å®—ç¥ ï¼Œè½å®—æ—é·å¾™çš„æ·±åº¦æ­·å²", val: "+4CultureDepth,+3Culture" },
                    { label: "B: æ¡èŒ¶ã€è¾²å ´é«”é©—ï¼Œè¦ªæ‰‹æ¥è§¸åœŸåœ°èˆ‡è‡ªç„¶", val: "+4Outdoor,+2LowCarbon" },
                ]
            },
            10: {
                "text": "Q10: æ‚¨å–œæ­¡æŒ‰ç…§è¦åŠƒå¥½çš„è¡Œç¨‹èµ°ï¼Œä¸å–œæ­¡æ—…é€”ä¸­è®Šå‹•å—ï¼Ÿ",
                "options": [
                    { label: "A: æ˜¯çš„ï¼Œè¦åŠƒå¥½çš„è·¯ç·šæœ€æœ‰æ•ˆç‡", val: "-3Pace,-2RiskAversion,+2CultureDepth" },
                    { label: "B: å¦ï¼Œæˆ‘å–œæ­¡å½ˆæ€§ã€å³èˆˆï¼Œéš¨æ™‚æ”¹è®Šæ–¹å‘", val: "+3Pace,+2RiskAversion,-2CultureDepth" },
                ]
            },
        };
        const TOTAL_QUIZ_STEPS = Object.keys(QUIZ_QUESTIONS).length; // ç¸½å…±æœ‰ 10 é¡Œ

        
        // --- 3. è¨Šæ¯ UI å‡½æ•¸ ---

        function addMessage(type, contentHTML, isQuiz = false) {
            const isBot = (type === 'bot' || type === 'quiz');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
            
            const contentDiv = document.createElement('div');
            // è®“ bot-message å®¹å™¨è‡ªé©æ‡‰å…§å®¹å¯¬åº¦
            contentDiv.className = `p-3 ${isBot ? 'bot-message' : 'user-message'}`; 

            if (isQuiz) {
                // æ¸¬é©—è¨Šæ¯ä½¿ç”¨ç‰¹æ®Šçš„å¡ç‰‡æ¨£å¼
                contentDiv.classList.add('flex-card', 'bg-white', 'p-4', 'shadow-lg', 'text-gray-800');
                contentDiv.classList.remove('p-3'); // ç§»é™¤æ¨™æº– padding
            } 

            if (isBot && !isQuiz) {
                // ä¸€èˆ¬æ©Ÿå™¨äººè¨Šæ¯
                contentDiv.innerHTML = `<i data-lucide="bot" class="w-4 h-4 mr-1 inline-block text-blue-900"></i> ${contentHTML}`;
            } else if (!isBot) {
                // ç”¨æˆ¶è¨Šæ¯
                contentDiv.innerHTML = contentHTML;
            } else if (isQuiz) {
                // æ¸¬é©—è¨Šæ¯ï¼Œå…§å®¹å·²åœ¨ createQuizMessage ä¸­çµæ§‹åŒ–
                contentDiv.innerHTML = contentHTML;
            }

            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            // ä¿®æ­£ï¼šç¢ºä¿ lucide å­˜åœ¨
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return contentDiv; // Return the actual message content div
        }

        // --- 4. æ¸¬é©— UI å‡½æ•¸ ---

        function createQuizMessage(questionData, currentStep) {
            const q = questionData.text;
            const options = questionData.options;
            
            let quizHTML = `
                <div class="text-xs text-gray-500 mb-2">å®¢é€” AI æ—…ä¼´ - æ—…éŠåå¥½å•å· (ç¬¬ ${currentStep}/${TOTAL_QUIZ_STEPS} é¡Œ)</div>
                <div class="text-lg font-bold text-blue-900 mb-3">${q}</div>
                <div class="space-y-2">
            `;

            options.forEach(option => {
                const nextStep = currentStep + 1;
                // data æ ¼å¼æ¨¡ä»¿ LINE Postback: action=next_quiz&step=2&val=+3Culture,+2CultureDepth
                const postbackData = `action=next_quiz&step=${nextStep}&val=${option.val}`;
                
                // æ¸¬é©—é¸é …æŒ‰éˆ•ä½¿ç”¨æ·±è—è‰²èª¿
                quizHTML += `
                    <button onclick="handlePostback('${postbackData}')" 
                            class="w-full text-left p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-sm transition duration-150 text-gray-800">
                        ${option.label}
                    </button>
                `;
            });

            quizHTML += `</div>`;
            
            addMessage('quiz', quizHTML, true);
        }
        
        // --- 5. è¡Œç¨‹è¦åŠƒå‡½æ•¸ ---
        function generateHakkaItinerary(userQuery, preferenceVector) {
            const query = userQuery.toLowerCase();
            const topPreference = Object.keys(preferenceVector).reduce((a, b) => preferenceVector[a] > preferenceVector[b] ? a : b);

            let candidates = HAKKA_ATTRACTIONS;
            let regionMatch = '';

            if (query.includes('æ¡ƒåœ’') || query.includes('é¾æ½­') || query.includes('å¤§æºª')) { regionMatch = 'æ¡ƒåœ’'; }
            else if (query.includes('æ–°ç«¹') || query.includes('å³¨çœ‰') || query.includes('åŒ—åŸ”') || query.includes('é—œè¥¿')) { regionMatch = 'æ–°ç«¹'; }
            else if (query.includes('è‹—æ —') || query.includes('å—åº„') || query.includes('ç…æ½­')) { regionMatch = 'è‹—æ —'; }
            else if (query.includes('å°ä¸­') || query.includes('æ±å‹¢') || query.includes('çŸ³å²¡')) { regionMatch = 'å°ä¸­'; }

            if (regionMatch) {
                candidates = candidates.filter(att => att.region === regionMatch);
            }
            
            let bestAttraction = candidates.sort((a, b) => {
                const scoreA = a.theme.includes(topPreference) ? 1 : 0;
                const scoreB = b.theme.includes(topPreference) ? 1 : 0;
                return scoreB - scoreA; 
            })[0] || candidates[Math.floor(Math.random() * candidates.length)]; 

            const C = preferenceVector['Culture'];
            const O = preferenceVector['Outdoor'];
            const P = preferenceVector['Pace'];
            const F = preferenceVector['Family'];

            let title = `ã€å°ä¸‰ç·šå®¢è£½åŒ–æ¨è–¦ã€‘${bestAttraction.region}ä¸»é¡Œä¹‹æ—…`;
            let theme = bestAttraction.theme.includes('Outdoor') ? "æˆ¶å¤–è‡ªç„¶æ¢ç´¢" : "å®¤å…§æ–‡åŒ–æ…¢æ´»";
            
            if (C > O && C > 5) { theme = "æ·±åº¦æ–‡å²èˆ‡å®¢å®¶é¢¨æƒ…"; }
            else if (O > C && O > 5) { theme = "å±±æ—æ­¥é“èˆ‡è‡ªç„¶ç™‚ç™’"; }
            if (P > 0) { theme += ", æ…¢æ´»æ­¥èª¿"; } else { theme += ", ç·Šæ¹Šè¡Œç¨‹"; }
            if (F > 5) { theme += ", è¦ªå­/ç„¡éšœç¤™å‹å–„"; }


            return {
                "title": title,
                "theme": theme,
                "recommendation_reason": `æ ¹æ“šæ‚¨çš„ã€${theme}ã€‘å‚¾å‘ï¼Œå°é˜¿å®¢ç‚ºæ‚¨ç²¾é¸äº†å°ä¸‰ç·šæœ€åˆé©çš„æ™¯é»ã€‚æœ¬æ¬¡è¡Œç¨‹åœ°é»ã€Œ${bestAttraction.name}ã€ä½æ–¼${bestAttraction.region}ï¼Œå®Œå…¨ç¬¦åˆæ‚¨åœ¨å•å·ä¸­å±•ç¾å‡ºçš„æ ¸å¿ƒåå¥½ã€‚`,
                "itinerary": [
                    {
                        "time": "10:00 - 12:00",
                        "name": bestAttraction.name,
                        "description": bestAttraction.description,
                        "location_url": bestAttraction.map_url
                    },
                    {
                        "time": "12:00 - 13:30",
                        "name": "åœ¨åœ°å®¢å®¶åˆé¤æ¨è–¦",
                        "description": P > 0 ? "æ…¢é£Ÿå®¢åº„ï¼šæ¨è–¦å°‹æ‰¾å··å¼„å…§çš„è€å­—è™Ÿå®¢å®¶å°é¤¨ï¼Œäº«å—æ…¢é£Ÿæ–‡åŒ–ã€‚" : "æ•ˆç‡åˆé¤ï¼šåœ¨è€è¡—å‘¨é‚Šå¿«é€Ÿå“åšåœ¨åœ°ç²„æ¢æˆ–è‚‰åœ“ã€‚",
                        "location_url": bestAttraction.map_url 
                    },
                    {
                        "time": "14:00 - 16:30",
                        "name": "å‘¨é‚Šç‰¹è‰²é«”é©—",
                        "description": O > C ? "æ¨è–¦å‘¨é‚Šçš„ä½ç¢³è‡ªè¡Œè»Šé“æˆ–ç”Ÿæ…‹è¾²å ´é«”é©—ã€‚" : "æ¨è–¦åœ¨å®—ç¥ æˆ–æ­·å²è¡—å€åƒèˆ‡å®¢å®¶DIYï¼ˆå¦‚æ“‚èŒ¶ã€è—æŸ“ï¼‰ã€‚",
                        "location_url": bestAttraction.map_url 
                    }
                ],
                "carbon_footprint_estimate": `${(12 - preferenceVector['LowCarbon']).toFixed(1)} kg CO2e`
            };
        }
        
        function createItineraryCard(itineraryJson) {
            let itineraryItemsHTML = '';
            itineraryJson.itinerary.forEach((item, index) => {
                itineraryItemsHTML += `
                    <div class="py-2 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center text-sm font-semibold text-gray-700 mb-1">
                            <i data-lucide="clock" class="w-4 h-4 mr-2 text-amber-500"></i>
                            ${item.time} - ${item.name}
                        </div>
                        <p class="text-xs text-gray-500 pl-6">${item.description}</p>
                        <a href="${item.location_url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 transition duration-150 pl-6 underline flex items-center mt-1">
                            <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> Google åœ°åœ–
                        </a>
                        <!-- æ–°å¢ï¼šGemini æ·±åº¦è§£èªªæŒ‰éˆ• -->
                        <button onclick="handleDeepDive('${item.name}')" class="mt-2 ml-6 text-xs text-white bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded transition duration-150">
                            âœ¨ æ™¯é»æ·±åº¦è§£èªª
                        </button>
                    </div>
                `;
            });
            
            const cardHTML = `
                <div class="flex-card w-full max-w-sm text-gray-800">
                    <div class="p-3 color-primary text-white rounded-t-xl">
                        <div class="text-xl font-bold">${itineraryJson.title}</div>
                        <div class="text-xs opacity-80 mt-1">ä¸»é¡Œ: ${itineraryJson.theme}</div>
                    </div>
                    
                    <div class="p-4 space-y-3">
                        <div class="border-b pb-3">
                            <div class="text-xs font-semibold text-blue-900 mb-1">å°é˜¿å®¢æ¨è–¦ç†ç”±:</div>
                            <p class="text-sm">${itineraryJson.recommendation_reason}</p>
                        </div>
                        
                        <div class="text-sm font-bold mt-3">ã€è©³ç´°è¡Œç¨‹ - å°ä¸‰ç·šå®¢åº„ã€‘</div>
                        ${itineraryItemsHTML}

                        <div class="text-right text-xs text-blue-600 font-medium pt-2">
                            ä½ç¢³ä¼°ç®—ï¼ˆåƒè€ƒå€¼ï¼‰: ${itineraryJson.carbon_footprint_estimate}
                        </div>
                    </div>

                    <div class="flex p-3 border-t bg-gray-50">
                        <button onclick="handlePostback('action=get_rain_plan')" class="flex-1 text-center py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold rounded-lg transition duration-200">
                            <i data-lucide="umbrella" class="w-4 h-4 inline-block mr-1"></i> é›¨å¤©å‚™æ¡ˆ
                        </button>
                    </div>
                </div>
            `;
            addMessage('bot', cardHTML, true);
        }
        
        // --- 6. æ—…å‹äººæ ¼ç”Ÿæˆ (ç§»é™¤åœ–åƒ API å‘¼å«ï¼Œå°ˆæ³¨æ–¼æµç¨‹) ---

        async function generatePersonalityMessage(finalPrefs) {
            const score = (dim) => finalPrefs[dim] || 0;

            let mainPersonality = "";  
            let traitDescription = ""; 
            let itineraryFocus = ""; 
            
            // 1. åˆ¤æ–·æ ¸å¿ƒç¶­åº¦
            const outdoorScore = score('Outdoor') - score('Indoor');
            const paceScore = score('Pace') * 0.5 - (score('CultureDepth') * 0.5 + score('RiskAversion') * 0.5);  
            const focusScore = score('CultureDepth') * 2 + score('Culture');
            
            // 2. æ—…å‹äººæ ¼åˆ†é¡
            if (focusScore > 8 && outdoorScore > 0) {
                mainPersonality = "ç²¾ç·»æ¢ç´¢å®¶ (The Cultured Explorer)";
                traitDescription = "æ‚¨çš„åŸºå› ï¼š**å…§æ–‚ã€è¦åŠƒã€çŸ¥è­˜äº«å—ã€æ¢ç´¢**ã€‚æ‚¨é‡è¦–æ—…ç¨‹çš„çŸ¥è­˜æ€§èˆ‡æ•ˆç‡ï¼Œå–œæ­¡æ·±å…¥æŒ–æ˜æ–‡åŒ–ï¼Œä¸¦é¡˜æ„èŠ±è²»æ™‚é–“èˆ‡ç²¾åŠ›å»æ¢ç´¢ç¨ç‰¹æ™¯é»ã€‚";
                itineraryFocus = "ã€ç²¾ç·»æ¢ç´¢å®¶ã€‘æ‚¨éœ€è¦çµåˆ**æ­·å²å¤è¹Ÿæ·±åº¦å°è¦½**èˆ‡**é«˜è³ªé‡æˆ¶å¤–é«”é©—**ã€‚æ‚¨çš„è¡Œç¨‹æ‡‰åŒ…å«æ˜ç¢ºçš„å­¸ç¿’ç›®æ¨™å’Œé«˜æ•ˆç‡çš„ç§»å‹•ï¼Œå°ˆæ³¨æ–¼è³ªé‡è€Œéæ•¸é‡ã€‚";
            } else if (outdoorScore < -4 && score('Pace') > 4) {
                mainPersonality = "æ‚ æ´»åº¦å‡å®¢ (The Relaxed Retreat)";
                traitDescription = "æ‚¨çš„åŸºå› ï¼š**éš¨å’Œã€æ‚ é–’ã€ç‰©è³ªäº«å—ã€å…§æ–‚**ã€‚æ‚¨è¿½æ±‚ç„¡å£“åŠ›çš„æ”¾é¬†èˆ‡èˆ’é©åº¦ï¼Œä½å®¿èˆ‡ç¾é£Ÿçš„å“è³ªå°æ‚¨å¾ˆé‡è¦ã€‚";
                itineraryFocus = "ã€æ‚ æ´»åº¦å‡å®¢ã€‘æ‚¨æ‡‰é¸æ“‡ä¸»æ‰“**é«˜å“è³ªå®¢åº„æ—…å®¿**ã€**åœ¨åœ°å®¢å®¶æ…¢é£Ÿ**ã€**å®¤å…§æ‰‹ä½œé«”é©—**ã€‚æ‚¨çš„æ—…è¡Œå“²å­¸æ˜¯ã€æ…¢ä¸‹ä¾†ï¼Œäº«å—ç•¶ä¸‹ã€ã€‚";
            } else if (outdoorScore > 4 && paceScore < -2) {
                mainPersonality = "è¡Œå‹•æ‹“è’è€… (The Action Pioneer)";
                traitDescription = "æ‚¨çš„åŸºå› ï¼š**å¤–å‘ã€ç·Šæ¹Šã€æ•ˆç‡ã€é–‹æ‹“**ã€‚æ‚¨æ“æœ‰é«˜å¼·åº¦çš„è¡Œå‹•åŠ›ï¼Œè¿½æ±‚åœ¨æœ‰é™çš„æ™‚é–“å…§èµ°è¨ªæœ€å¤šçš„æˆ¶å¤–æ™¯é»ï¼Œè¡Œç¨‹é€šå¸¸é«˜æ•ˆä¸”å……æ»¿æŒ‘æˆ°æ€§ã€‚";
                itineraryFocus = "ã€è¡Œå‹•æ‹“è’è€…ã€‘æ‚¨éœ€è¦ç·Šæ¹Šä¸”é«˜å¼·åº¦çš„è¡Œç¨‹ã€‚å»ºè­°è¡Œç¨‹ï¼š**æŒ‘æˆ°å‹å±±å€å¥è¡Œ**ã€**é•·è·é›¢å–®è»Šé¨è¡Œ**ï¼Œå°‡å°ä¸‰ç·šçš„è‡ªç„¶æ™¯é»ä¸€ç¶²æ‰“ç›¡ã€‚";
            } else {
                mainPersonality = "å¹³å’Œå„ªéŠå®¶ (The Harmonious Wanderer)";
                traitDescription = "æ‚¨çš„åŸºå› ï¼š**éš¨å’Œã€å¹³è¡¡ã€å…±äº«ã€ç„¡çˆ­**ã€‚æ‚¨å¸Œæœ›æ—…ç¨‹å¹³é †ã€èˆ’é©ï¼Œæ¨‚æ–¼é…åˆæ—…ä¼´çš„éœ€æ±‚ã€‚é‡è¦–ä½é¢¨éšªã€è¦ªå­/é•·è€…å‹å–„çš„ç’°å¢ƒã€‚";
                itineraryFocus = "ã€å¹³å’Œå„ªéŠå®¶ã€‘æ‚¨é©åˆé¸æ“‡**äº¤é€šä¾¿åˆ©ã€é…å¥—è¨­æ–½å®Œå–„**çš„æ™¯é»ï¼ˆå¦‚å¤§å‹å®¢å®¶æ–‡åŒ–åœ’å€ã€æ˜“é”è€è¡—ï¼‰ï¼Œç¢ºä¿è¡Œç¨‹æµæš¢ä¸”æ‰€æœ‰æ—…ä¼´éƒ½èƒ½èˆ’é©åƒèˆ‡ã€‚";
            }
            
            let finalMessageContent = `
                <div class="p-3 w-full">
                    <div class="text-xl font-bold text-blue-900 border-b-2 border-blue-900 pb-2 mb-3 text-center">æ‚¨çš„æ—…å‹äººæ ¼æ­æ›‰ï¼</div>
                    <div class="text-3xl font-extrabold text-amber-600 mb-2 text-center">${mainPersonality}</div>
                    <div class="text-sm text-gray-700 font-medium mb-4 text-center">${traitDescription}</div>
                    
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <div class="text-sm font-semibold text-blue-900 mb-1">å°é˜¿å®¢çš„å®¢è£½åŒ–è¡Œç¨‹å»ºè­°ï¼š</div>
                        <p class="text-sm text-gray-600">${itineraryFocus}</p>
                        <p class="mt-3 text-xs text-blue-600">ç¾åœ¨è«‹è¼¸å…¥æ‚¨çš„æ—…éŠéœ€æ±‚ (ä¾‹å¦‚ï¼šã€æ–°ç«¹å³¨çœ‰ï¼Œæˆ¶å¤–æ´»å‹•ã€ æˆ– ã€æƒ³å»è‹—æ —å—åº„ï¼Œæ…¢æ´»ä¸»é¡Œã€)ï¼Œå°é˜¿å®¢æœƒç«‹å³ç‚ºæ‚¨è¦åŠƒ**æœ€å®¢è£½åŒ–**çš„å°ä¸‰ç·šå®¢åº„è¡Œç¨‹ï¼</p>
                    </div>
                </div>
            `;
            
            // å°‡æœ€çµ‚å…§å®¹æ·»åŠ åˆ°èŠå¤©
            addMessage('quiz', finalMessageContent, true);
        }

        // --- 7. Gemini API æ ¸å¿ƒåŠŸèƒ½ ---

        /**
         * å‘¼å« Gemini API é€²è¡Œæ–‡æœ¬ç”Ÿæˆ (æ”¯æ´ Google Search Grounding)
         * @param {string} userQuery - ç”¨æˆ¶è¼¸å…¥çš„æŸ¥è©¢
         * @param {string} systemPrompt - è§’è‰²å’Œè¦å‰‡è¨­å®š
         * @param {boolean} useGrounding - æ˜¯å¦ä½¿ç”¨ Google Search é€²è¡Œè³‡æ–™å¢å¼·
         * @returns {Promise<{text: string, sources: Array<{uri: string, title: string}>}>}
         */
        async function callGeminiAPI(userQuery, systemPrompt, useGrounding = true) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: useGrounding ? [{ "google_search": {} }] : undefined,
            };

            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                    }
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    }
                    throw new Error("API response format error or content missing.");

                } catch (error) {
                    attempts++;
                    if (attempts < maxAttempts) {
                        // æŒ‡æ•¸é€€é¿
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Gemini API call failed after ${maxAttempts} attempts: ${error.message}`);
                    }
                }
            }
        }

        /**
         * è™•ç†æ™¯é»æ·±åº¦è§£èªªè«‹æ±‚ (Gemini LLM)
         * @param {string} attractionName - æ™¯é»åç¨±
         */
        async function handleDeepDive(attractionName) {
            addMessage('user', `âœ¨ è«‹çµ¦æˆ‘æ™¯é»ã€${attractionName}ã€‘çš„æ·±åº¦è§£èªªã€‚`);
            
            const loadingMessageDiv = addMessage('bot', `<i data-lucide="loader" class="w-4 h-4 mr-1 inline-block animate-spin text-blue-700"></i> å°é˜¿å®¢æ­£åœ¨é€éç¶²è·¯æŸ¥è©¢ã€${attractionName}ã€‘çš„æ­·å²æ–‡åŒ–èƒŒæ™¯...`);
            
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆé–€æä¾›å°ç£å®¢åº„æ­·å²ã€æ–‡åŒ–å’Œæ—…éŠè³‡è¨Šçš„å°ˆå®¶ã€‚è«‹æ ¹æ“š Google Search æä¾›çš„è³‡è¨Šï¼Œç‚ºç”¨æˆ¶ç”Ÿæˆä¸€æ®µç´„ 150 å­—çš„æ·±åº¦è§£èªªï¼Œå…§å®¹éœ€åŒ…å«æ­·å²æ·µæºã€å®¢å®¶æ–‡åŒ–é€£çµä»¥åŠæ—…éŠäº®é»ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚";
            const userQuery = `æ™¯é»åç¨±: ${attractionName}. è«‹è©³ç´°èªªæ˜é€™å€‹æ™¯é»çš„æ­·å²å’Œå®¢å®¶æ–‡åŒ–æ„ç¾©ã€‚`;

            try {
                const { text, sources } = await callGeminiAPI(userQuery, systemPrompt, true);
                
                let sourceHTML = '';
                if (sources.length > 0) {
                    sourceHTML = sources.map(s => 
                        `<a href="${s.uri}" target="_blank" class="text-xs text-blue-600 hover:underline block truncate" title="${s.title}">${s.title}</a>`
                    ).join('');
                    sourceHTML = `<div class="mt-2 pt-2 border-t border-gray-100"><div class="text-xs font-semibold text-gray-500">è³‡è¨Šä¾†æº:</div>${sourceHTML}</div>`;
                }

                const responseHTML = `
                    <div class="font-bold text-blue-900 mb-2">âœ¨ã€${attractionName} æ·±åº¦è§£èªªã€‘</div>
                    <p class="text-sm text-gray-700">${text}</p>
                    ${sourceHTML}
                `;
                
                loadingMessageDiv.innerHTML = responseHTML; // æ›¿æ›è¼‰å…¥ä¸­çš„è¨Šæ¯
                if (typeof lucide !== 'undefined' && lucide.createIcons) { lucide.createIcons(); }

            } catch (error) {
                loadingMessageDiv.innerHTML = `<div class="text-red-600">æŠ±æ­‰ï¼Œæ·±åº¦è§£èªªåŠŸèƒ½å¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${error.message}</div>`;
                console.error("Deep Dive Error:", error);
            }
        }

        /**
         * è™•ç†å®¢åº„æ–‡åŒ–å•ç­” (é€šç”¨èŠå¤©åŠŸèƒ½)
         * @param {string} userQuery - ç”¨æˆ¶çš„åŸå§‹æå•
         */
        async function handleCultureQA(userQuery) {
            const loadingMessageDiv = addMessage('bot', `<i data-lucide="loader" class="w-4 h-4 mr-1 inline-block animate-spin text-blue-700"></i> å°é˜¿å®¢æ­£åœ¨æ€è€ƒæ‚¨çš„å®¢åº„æ–‡åŒ–å•é¡Œ...`);
            
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆé–€å›ç­”å°ç£å®¢å®¶æ–‡åŒ–ã€æ­·å²ã€ç¿’ä¿—å’Œç¾é£Ÿçš„å°ˆå®¶ã€‚è«‹æ ¹æ“š Google Search æä¾›çš„è³‡è¨Šï¼Œç”¨æ¸…æ™°ã€å‹å–„çš„èªæ°£å›ç­”ç”¨æˆ¶çš„æå•ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚";
            
            try {
                const { text, sources } = await callGeminiAPI(userQuery, systemPrompt, true);
                
                let sourceHTML = '';
                if (sources.length > 0) {
                    sourceHTML = sources.map(s => 
                        `<a href="${s.uri}" target="_blank" class="text-xs text-blue-600 hover:underline block truncate" title="${s.title}">${s.title}</a>`
                    ).join('');
                    sourceHTML = `<div class="mt-2 pt-2 border-t border-gray-100"><div class="text-xs font-semibold text-gray-500">è³‡è¨Šä¾†æº:</div>${sourceHTML}</div>`;
                }

                const responseHTML = `
                    <div class="font-bold text-blue-900 mb-2">ğŸ’¡ å®¢åº„æ–‡åŒ–å°çŸ¥è­˜</div>
                    <p class="text-sm text-gray-700">${text}</p>
                    ${sourceHTML}
                `;
                
                loadingMessageDiv.innerHTML = responseHTML; // æ›¿æ›è¼‰å…¥ä¸­çš„è¨Šæ¯
                if (typeof lucide !== 'undefined' && lucide.createIcons) { lucide.createIcons(); }

            } catch (error) {
                loadingMessageDiv.innerHTML = `<div class="text-red-600">æŠ±æ­‰ï¼Œæ–‡åŒ–å•ç­”åŠŸèƒ½å¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${error.message}</div>`;
                console.error("Culture QA Error:", error);
            }
        }


        // --- 8. äº‹ä»¶è™•ç† (æ›´æ–°) ---

        async function handlePostback(data) {
            const params = new URLSearchParams(data);
            const action = params.get('action');

            if (action === 'next_quiz') {
                const nextStep = parseInt(params.get('step'));
                const valString = params.get('val');
                
                updatePreferenceVector(valString);
                currentQuizStep = nextStep; 

                if (nextStep <= TOTAL_QUIZ_STEPS) {
                    const quizData = QUIZ_QUESTIONS[nextStep];
                    createQuizMessage(quizData, nextStep);
                    saveStateToLocalStorage();
                } else {
                    currentQuizStep = TOTAL_QUIZ_STEPS;
                    saveStateToLocalStorage();
                    await generatePersonalityMessage(currentPreferences);
                }

            } else if (action === 'get_rain_plan') {
                addMessage('bot', 'å¥½çš„ï¼Œå°é˜¿å®¢æ”¶åˆ°é›¨å¤©å‚™æ¡ˆè«‹æ±‚ï¼è‹¥é‡ä¸‹é›¨ï¼Œå»ºè­°å°‡æˆ¶å¤–æ­¥é“æ”¹ç‚ºåƒè§€é™„è¿‘çš„**å®¢å®¶æ–‡åŒ–æœƒé¤¨**æˆ–**å®¤å…§DIYé«”é©—**ï¼ˆå¦‚ç±³é£Ÿè£½ä½œï¼‰ã€‚');
            }
        }

        async function handleMessage(text) {
            
            // æ¨¡æ“¬ç”¨æˆ¶ç™¼é€è¨Šæ¯
            addMessage('user', text);

            const isRestart = text === "é‡æ–°æ¸¬é©—" || text === "é–‹å§‹å•å·";
            const isFinished = currentQuizStep >= TOTAL_QUIZ_STEPS;
            const isPlanning = text.includes('è¦åŠƒè¡Œç¨‹') || text.includes('è¡Œç¨‹') || text.includes('é¡¯ç¤ºçµæœ');
            
            if (isRestart) {
                currentQuizStep = 0;
                currentPreferences = { ...PREFERENCE_DIMENSIONS };
                saveStateToLocalStorage();
            }

            // 1. æ¸¬é©—æµç¨‹
            if (currentQuizStep === 0) {
                if (isPlanning && !isRestart) {
                    addMessage('bot', "å°é˜¿å®¢äº†è§£æ‚¨çš„éœ€æ±‚ï¼è«‹å…ˆé»æ“Šã€Œé–‹å§‹å•å·ã€æŒ‰éˆ•ï¼Œå®Œæˆ **10 é¡Œå®¢åº„æ—…éŠå•å·**ï¼Œä»¥ç²å¾—æœ€å®¢è£½åŒ–çš„è¡Œç¨‹å»ºè­°ã€‚");
                    return; 
                }
                const quizData = QUIZ_QUESTIONS[1];
                createQuizMessage(quizData, 1);
                currentQuizStep = 1;
                saveStateToLocalStorage();
                return;
            }

            // 2. è¦åŠƒæµç¨‹ (å¿…é ˆå®Œæˆæ¸¬é©—)
            if (isPlanning && isFinished) {
                try {
                    addMessage('bot', `<i data-lucide="loader" class="w-4 h-4 mr-1 inline-block animate-spin text-blue-700"></i> å°é˜¿å®¢æ­£åœ¨æ ¹æ“šæ‚¨çš„æ—…å‹äººæ ¼å’Œã€Œ${text}ã€è¦åŠƒ**å°ä¸‰ç·šå®¢åº„è¡Œç¨‹**ä¸­... è«‹ç¨å€™ã€‚`);
                    
                    // æ¨¡æ“¬ 1.5 ç§’å»¶é²ä¾†æ¨¡æ“¬ RAG/LLM å‘¼å«æ™‚é–“
                    setTimeout(() => {
                        const itineraryJson = generateHakkaItinerary(text, currentPreferences);
                        createItineraryCard(itineraryJson);
                    }, 1500);

                } catch (e) {
                    addMessage('bot', `å°ä¸èµ·ï¼Œè¡Œç¨‹è¦åŠƒç³»çµ±å‡ºç¾éŒ¯èª¤: ${e.message}`);
                    console.error("è¡Œç¨‹è¦åŠƒéŒ¯èª¤:", e);
                }
            // 3. æ–‡åŒ–å•ç­” (é€šç”¨ LLM åŠŸèƒ½)
            } else if (isFinished || (currentQuizStep > 0 && !isPlanning)) {
                // å¦‚æœå·²å®Œæˆæ¸¬é©— OR æ­£åœ¨æ¸¬é©—ä½†è¼¸å…¥éæ¸¬é©—ç­”æ¡ˆï¼Œå‰‡è¦–ç‚ºé€šç”¨å•ç­”
                if (text.length > 5 && !text.includes('é¡¯ç¤ºçµæœ')) {
                     await handleCultureQA(text);
                } else if (!isFinished) {
                     addMessage('bot', `è«‹å…ˆå›ç­”ç›®å‰çš„ç¬¬ ${currentQuizStep} é¡Œï¼Œæ‰èƒ½ç¹¼çºŒå–”ï¼`);
                }
            }
        }

        function sendMessage() {
            const text = userInput.value.trim();
            if (text) {
                handleMessage(text);
                userInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            }
        }
        
        // --- å…¨åŸŸæ›å…‰å‡½å¼ä»¥è§£æ±º ReferenceError ---
        window.handleMessage = handleMessage;
        window.handlePostback = handlePostback;
        window.sendMessage = sendMessage;
        window.handleDeepDive = handleDeepDive; // æ›å…‰æ–°çš„ LLM å‡½æ•¸
        window.startApp = startApp; 


        // --- 9. ç¶²é è¼‰å…¥åˆå§‹åŒ– ---
        function initializeApp() {
            // 1. ç¶å®šå…¨åŸŸå‡½å¼ (è§£æ±º ReferenceError)
            window.handleMessage = handleMessage;
            window.handlePostback = handlePostback;
            window.sendMessage = sendMessage;
            window.handleDeepDive = handleDeepDive; // æ›å…‰æ–°çš„ LLM å‡½æ•¸
            window.startApp = startApp; 

            // 2. åˆå§‹ç‹€æ…‹è¼‰å…¥
            loadStateFromLocalStorage();

            // 3. ç¶å®š Splash Screen æŒ‰éˆ•
            document.getElementById('start-button').addEventListener('click', startApp);

            // 4. ç¢ºä¿ Lucide Icons åˆå§‹æ¸²æŸ“
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // --- æ‡‰ç”¨ç¨‹å¼ä¸»é‚è¼¯ (ç”± Splash Screen å‘¼å«) ---
        function startApp() {
            const splash = document.getElementById('splash-screen');
            const app = document.getElementById('app-container');
            
            // è½‰å ´å‹•ç•«ï¼šæ·¡å‡º Splash Screenï¼Œæ·¡å…¥ App ä»‹é¢
            splash.style.animation = 'fadeOut 0.5s ease-in forwards';
            
            setTimeout(() => {
                splash.style.display = 'none';
                app.style.display = 'flex';
                app.style.animation = 'fadeIn 0.5s ease-out';
                
                // å•Ÿå‹•èŠå¤©ä»‹é¢åˆå§‹åŒ–
                
                // 1. åˆå§‹å•å€™èª
                addMessage('bot', `æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„å®¢é€” AI æ—…ä¼´ â€” **å°é˜¿å®¢**ï¼<br>
                                    æˆ‘å€‘å°‡æ¢ç´¢å°ä¸‰ç·šï¼ˆæµªæ¼«å®¢åº„å¤§é“ï¼‰çš„ç¨ç‰¹é­…åŠ›ã€‚<br>
                                    ç‚ºäº†çµ¦æ‚¨æœ€è²¼å¿ƒçš„è¡Œç¨‹å»ºè­°ï¼Œè«‹å…ˆé»æ“Šä¸‹æ–¹ã€Œé–‹å§‹å•å·ã€ã€‚`);
                
                // 2. é¡¯ç¤º ID å’Œå½±ç‰‡æç¤º
                userIdDisplay.innerHTML = generateAnonUserId(); 
                addMessage('bot', `<i data-lucide="video" class="w-4 h-4 mr-1 inline-block text-blue-700"></i> (æç¤º: å‰ç¥¥ç‰©å‹•ç•« 1213.mp4 å·²åœ¨å´é‚Šæ¬„è¼‰å…¥ï¼Œæ­¡è¿è§€è³ï¼)`);
                
                // 3. æ ¹æ“šç‹€æ…‹æ±ºå®šé¡¯ç¤ºæŒ‰éˆ•æˆ–ç›´æ¥é¡¯ç¤ºçµæœ
                if (currentQuizStep >= TOTAL_QUIZ_STEPS) {
                    // å¦‚æœå·²ç¶“æœ‰çµæœï¼Œç›´æ¥é¡¯ç¤º
                    setTimeout(async () => {
                         await generatePersonalityMessage(currentPreferences);
                    }, 500);
                } else {
                    // é¡¯ç¤ºé–‹å§‹æŒ‰éˆ• (æ¨¡æ“¬ Rich Menu äº’å‹•)
                    setTimeout(() => {
                        const quizStartButton = `
                            <div class="w-full text-center">
                                <button onclick="handleMessage('é‡æ–°æ¸¬é©—')" class="color-accent hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200 shadow-md">
                                    é»æˆ‘é–‹å§‹å•å·ï¼
                                </button>
                            </div>
                        `;
                        addMessage('quiz', quizStartButton, true);
                    }, 500);
                }
            }, 500); // ç¢ºä¿æ·¡å‡ºå‹•ç•«å®Œæˆ
        }


        // --- 9. ç¶²é è¼‰å…¥åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
