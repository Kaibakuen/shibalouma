<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客途 AI 旅伴 - 台三線景點規劃版</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 使用 Inter 字體 */
        :root { font-family: 'Inter', sans-serif; }
        /* 模擬 LINE 聊天背景 */
        body { background-color: #f0f0f0; }
        #chat-window {
            background-color: #e5ddd5; /* 輕微的米白色背景 */
            max-width: 480px;
            height: 90vh; /* 增加高度 */
            max-height: 800px;
            margin: 20px auto;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .bot-message {
            background-color: #ffffff;
            border-radius: 15px 15px 15px 5px;
            max-width: 90%; /* 確保內容能完整顯示 */
            /* 讓 bot-message 容器本身具有彈性，以包裹圖片 */
            display: inline-block; 
        }
        .user-message {
            background-color: #a8e48b; /* LINE 綠 */
            border-radius: 15px 15px 5px 15px;
            max-width: 80%;
        }
        .flex-card {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            border: 1px solid #ddd;
        }
        /* 讓 Lucide Icon 渲染 */
        [data-lucide] { display: inline-block; }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center min-h-screen">

    <div id="chat-window">
        <!-- Chat Header -->
        <div class="p-4 bg-green-700 text-white shadow-md flex items-center justify-center rounded-t-xl">
            <i data-lucide="map-pin" class="w-5 h-5 mr-2"></i>
            <h1 class="text-xl font-bold">客途 AI 旅伴 - 浪漫台三線</h1>
        </div>

        <!-- Messages Container -->
        <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-4">
            <!-- Initial Message Placeholder -->
        </div>

        <!-- Input Area (Rich Menu & Text Input Simulation) -->
        <div id="input-area" class="p-4 bg-gray-100 border-t border-gray-300">
            <div id="rich-menu-sim" class="flex justify-center space-x-2 mb-3">
                <button onclick="handleMessage('我想規劃行程')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs px-3 py-1 rounded-full shadow-md transition duration-200">
                    <i data-lucide="route" class="w-3 h-3 inline-block"></i> 直接規劃
                </button>
                <button onclick="handleMessage('重新測驗')" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded-full shadow-md transition duration-200">
                    <i data-lucide="list-checks" class="w-3 h-3 inline-block"></i> 開始問卷
                </button>
            </div>
            <div class="flex">
                <input type="text" id="user-input" placeholder="例如：新竹峨眉，戶外活動" class="flex-1 p-2 border border-gray-300 rounded-l-lg focus:outline-none" onkeyup="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-green-500 hover:bg-green-600 text-white px-4 rounded-r-lg shadow-md transition duration-200">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 核心數據結構 (用於儲存用戶狀態與偏好向量) ---

        const USER_STATUS_DB = {};
        const DEFAULT_USER_ID = "web_user_123";
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('user-input');

        // 旅遊偏好維度
        const PREFERENCE_DIMENSIONS = {
            "Culture": 0, "Outdoor": 0, "Pace": 0, "LowCarbon": 0,
            "Family": 0, "Accessibility": 0, "CultureDepth": 0,
            "Indoor": 0, "RiskAversion": 0
        };

        // 台三線景點資料庫 (真實景點，模擬 Google Maps 連結)
        const HAKKA_ATTRACTIONS = [
            { id: 1, region: "桃園", name: "大溪老街 (Daxi Old Street)", theme: ["Culture", "Indoor", "Pace"], description: "充滿巴洛克式立面建築的歷史街區，適合室內文化探索與慢步調。", map_url: "https://maps.app.goo.gl/yQ9fQ7k7yJ6eLg9v9" },
            { id: 2, region: "新竹", name: "北埔老街/金廣福公館", theme: ["Culture", "CultureDepth", "Indoor"], description: "北台灣客家文化的中心，必嚐擂茶，適合文史愛好者深度探索。", map_url: "https://maps.app.goo.gl/6E6oN2hV1r9XJz3f7" },
            { id: 3, region: "新竹", name: "峨眉湖/細茅埔吊橋", theme: ["Outdoor", "LowCarbon", "Pace"], description: "湖畔步道與生態景觀，適合戶外、騎單車的低碳慢活路線。", map_url: "https://maps.app.goo.gl/DkK8Z7yB7N8xT6rD7" },
            { id: 4, region: "苗栗", name: "獅頭山風景區", theme: ["Outdoor", "CultureDepth", "RiskAversion"], description: "健行步道與古道文化，是挑戰型的戶外登山健行首選。", map_url: "https://maps.app.goo.gl/yP7jXg4Z1b6hC5rP9" },
            { id: 5, region: "苗栗", name: "南庄老街 (桂花巷)", theme: ["Culture", "Indoor", "Family"], description: "輕鬆逛街、品嚐客家小吃，具備親子友善設施。", map_url: "https://maps.app.goo.gl/wU2aD6yZ9k7qL5xK8" },
            { id: 6, region: "台中", name: "東勢客家文化園區 (自行車道)", theme: ["LowCarbon", "Outdoor", "Pace"], description: "舊火車站改建，結合鐵道文化與綠色廊道，是單車活動的最佳起點。", map_url: "https://maps.app.goo.gl/Gj8xN4bY5rE2pA3c6" }
        ];

        // 10 題旅遊偏好問卷及其向量權重
        const QUIZ_QUESTIONS = {
            1: {
                "text": "Q1: 旅程規劃時，比起聊天，您更喜歡安靜做自己的事嗎？",
                "options": [
                    { label: "A: 是的，我需要時間獨自沉澱或思考", val: "+3Indoor,+2Pace,-1Outdoor" },
                    { label: "B: 否，我喜歡與旅伴討論，共同決定", val: "+3Outdoor,-1Indoor,-2Pace" },
                ]
            },
            2: {
                "text": "Q2: 您覺得能睡飽，比早起趕行程、看美景更重要嗎？",
                "options": [
                    { label: "A: 是的，休息是旅行的重點", val: "+3Pace,+2Indoor,-2Outdoor" },
                    { label: "B: 否，我願意早起把握時間多玩一點", val: "-3Pace,+2Outdoor,+2RiskAversion" },
                ]
            },
            3: {
                "text": "Q3: 在人多熱鬧的老街或聚會場所，您會感到活力充沛嗎？",
                "options": [
                    { label: "A: 是的，我享受社交和人群的熱鬧", val: "-3Indoor,+2Culture,-1Pace" },
                    { label: "B: 否，我更喜歡安靜的自然或歷史景點", val: "+3Indoor,+2Pace,-2Culture" },
                ]
            },
            4: {
                "text": "Q4: 您對住宿環境有潔癖，或是在意舒適度嗎？",
                "options": [
                    { label: "A: 是的，住宿的品質會影響我的心情", val: "+3Indoor,+2RiskAversion,-1LowCarbon" },
                    { label: "B: 否，只要有基本功能，便宜即可", val: "-3Indoor,-2RiskAversion,+1LowCarbon" },
                ]
            },
            5: {
                "text": "Q5: 您喜歡走路，長時間的徒步探索不是問題嗎？",
                "options": [
                    { label: "A: 是的，我喜歡用雙腳深度探索", val: "+4Outdoor,+3LowCarbon,+2CultureDepth" },
                    { label: "B: 否，我偏好搭乘交通工具或短程移動", val: "-3Outdoor,-2LowCarbon,+2Pace" },
                ]
            },
            6: {
                "text": "Q6: 規劃行程時，您會先考量是否有兒童或長者友善設施嗎？",
                "options": [
                    { label: "A: 是的，所有人的舒適度是我的首要考量", val: "+4Family,+4Accessibility,+2RiskAversion" },
                    { label: "B: 否，我以景點的獨特性和個人興趣為主", val: "-3Family,-3Accessibility,-1RiskAversion" },
                ]
            },
            7: {
                "text": "Q7: 旅程中遇到突發狀況，您傾向立即啟動備用方案，避免任何風險嗎？",
                "options": [
                    { label: "A: 是的，我討厭行程被打亂", val: "+4RiskAversion,+2Indoor,-2Pace" },
                    { label: "B: 否，我願意隨機應變，甚至接受意外的驚喜", val: "-4RiskAversion,+2Outdoor,+2Pace" },
                ]
            },
            8: {
                "text": "Q8: 您會設定旅程預算並且實際控管，捨不得花太多錢享受美食嗎？",
                "options": [
                    { label: "A: 是的，控制預算比美食享受重要", val: "+3LowCarbon,-3Indoor" },
                    { label: "B: 否，我蠻捨得花錢享受美食的", val: "-3LowCarbon,+3Indoor" },
                ]
            },
            9: {
                "text": "Q9: 哪種客庄體驗對您更有吸引力？",
                "options": [
                    { label: "A: 參觀客家宗祠，聽宗族遷徙的深度歷史", val: "+4CultureDepth,+3Culture" },
                    { label: "B: 採茶、農場體驗，親手接觸土地與自然", val: "+4Outdoor,+2LowCarbon" },
                ]
            },
            10: {
                "text": "Q10: 您喜歡按照規劃好的行程走，不喜歡旅途中變動嗎？",
                "options": [
                    { label: "A: 是的，規劃好的路線最有效率", val: "-3Pace,-2RiskAversion,+2CultureDepth" },
                    { label: "B: 否，我喜歡彈性、即興，隨時改變方向", val: "+3Pace,+2RiskAversion,-2CultureDepth" },
                ]
            },
        };
        const TOTAL_QUIZ_STEPS = Object.keys(QUIZ_QUESTIONS).length; // 總共有 10 題

        // --- 核心邏輯函數 (保持不變) ---

        function getUserState(userId) {
            if (!USER_STATUS_DB[userId]) {
                USER_STATUS_DB[userId] = {
                    "quiz_step": 0,
                    "preferences": { ...PREFERENCE_DIMENSIONS }
                };
            }
            return USER_STATUS_DB[userId];
        }

        function updatePreferenceVector(userId, valString) {
            const state = getUserState(userId);
            
            (valString || "").split(',').forEach(item => { 
                if (!item) return;
                
                const matches = item.match(/([+-]\d+)([A-Za-z]+)/                );
                if (matches && matches.length === 3) {
                    const val = parseInt(matches[1]);
                    const dim = matches[2];
                    
                    if (dim in state.preferences) {
                        state.preferences[dim] += val;
                    }
                }
            });
            return state.preferences;
        }

        // --- 訊息 UI 函數 (微調 bot-message 結構以確保圖片顯示) ---

        function addMessage(type, contentHTML, isQuiz = false) {
            const isBot = (type === 'bot' || type === 'quiz');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
            
            const contentDiv = document.createElement('div');
            // 讓 bot-message 容器自適應內容寬度
            contentDiv.className = `p-3 ${isBot ? 'bot-message' : 'user-message'}`; 

            if (isQuiz) {
                // 測驗訊息使用特殊的卡片樣式
                contentDiv.classList.add('flex-card', 'bg-white', 'p-4', 'shadow-lg', 'text-gray-800');
                contentDiv.classList.remove('p-3'); // 移除標準 padding
            } 

            if (isBot && !isQuiz) {
                // 一般機器人訊息
                contentDiv.innerHTML = `<i data-lucide="bot" class="w-4 h-4 mr-1 inline-block text-green-700"></i> ${contentHTML}`;
            } else if (!isBot) {
                // 用戶訊息
                contentDiv.innerHTML = contentHTML;
            } else if (isQuiz) {
                // 測驗訊息，內容已在 createQuizMessage 中結構化
                contentDiv.innerHTML = contentHTML;
            }

            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            lucide.createIcons();
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return contentDiv; // Return the actual message content div
        }

        // --- 測驗 UI 函數 (保持不變) ---

        function createQuizMessage(questionData, currentStep) {
            const q = questionData.text;
            const options = questionData.options;
            
            let quizHTML = `
                <div class="text-xs text-gray-500 mb-2">客途 AI 旅伴 - 旅遊偏好問卷 (第 ${currentStep}/${TOTAL_QUIZ_STEPS} 題)</div>
                <div class="text-lg font-bold text-green-700 mb-3">${q}</div>
                <div class="space-y-2">
            `;

            options.forEach(option => {
                const nextStep = currentStep + 1;
                // data 格式模仿 LINE Postback: action=next_quiz&step=2&val=+3Culture,+2CultureDepth
                const postbackData = `action=next_quiz&step=${nextStep}&val=${option.val}`;
                
                quizHTML += `
                    <button onclick="handlePostback('${postbackData}')" 
                            class="w-full text-left p-3 bg-gray-50 hover:bg-green-100 border border-green-200 rounded-lg text-sm transition duration-150">
                        ${option.label}
                    </button>
                `;
            });

            quizHTML += `</div>`;
            
            addMessage('quiz', quizHTML, true);
        }
        
        // --- 行程規劃函數 (保持不變) ---
        function generateHakkaItinerary(userQuery, preferenceVector) {
            const query = userQuery.toLowerCase();
            const topPreference = Object.keys(preferenceVector).reduce((a, b) => preferenceVector[a] > preferenceVector[b] ? a : b);

            let candidates = HAKKA_ATTRACTIONS;
            let regionMatch = '';

            if (query.includes('桃園') || query.includes('龍潭') || query.includes('大溪')) { regionMatch = '桃園'; }
            else if (query.includes('新竹') || query.includes('峨眉') || query.includes('北埔') || query.includes('關西')) { regionMatch = '新竹'; }
            else if (query.includes('苗栗') || query.includes('南庄') || query.includes('獅潭')) { regionMatch = '苗栗'; }
            else if (query.includes('台中') || query.includes('東勢') || query.includes('石岡')) { regionMatch = '台中'; }

            if (regionMatch) {
                candidates = candidates.filter(att => att.region === regionMatch);
            }
            
            let bestAttraction = candidates.sort((a, b) => {
                const scoreA = a.theme.includes(topPreference) ? 1 : 0;
                const scoreB = b.theme.includes(topPreference) ? 1 : 0;
                return scoreB - scoreA; 
            })[0] || candidates[Math.floor(Math.random() * candidates.length)]; 

            const C = preferenceVector['Culture'];
            const O = preferenceVector['Outdoor'];
            const P = preferenceVector['Pace'];
            const F = preferenceVector['Family'];

            let title = `【台三線客製化推薦】${bestAttraction.region}主題之旅`;
            let theme = bestAttraction.theme.includes('Outdoor') ? "戶外自然探索" : "室內文化慢活";
            
            if (C > O && C > 5) { theme = "深度文史與客家風情"; }
            else if (O > C && O > 5) { theme = "山林步道與自然療癒"; }
            if (P > 0) { theme += ", 慢活步調"; } else { theme += ", 緊湊行程"; }
            if (F > 5) { theme += ", 親子/無障礙友善"; }


            return {
                "title": title,
                "theme": theme,
                "recommendation_reason": `根據您的【${theme}】傾向，小阿客為您精選了台三線最合適的景點。本次行程地點「${bestAttraction.name}」位於${bestAttraction.region}，完全符合您在問卷中展現出的核心偏好。`,
                "itinerary": [
                    {
                        "time": "10:00 - 12:00",
                        "name": bestAttraction.name,
                        "description": bestAttraction.description,
                        "location_url": bestAttraction.map_url
                    },
                    {
                        "time": "12:00 - 13:30",
                        "name": "在地客家午餐推薦",
                        "description": P > 0 ? "慢食客庄：推薦尋找巷弄內的老字號客家小館，享受慢食文化。" : "效率午餐：在老街周邊快速品嚐在地粄條或肉圓。",
                        "location_url": bestAttraction.map_url 
                    },
                    {
                        "time": "14:00 - 16:30",
                        "name": "周邊特色體驗",
                        "description": O > C ? "推薦周邊的低碳自行車道或生態農場體驗。" : "推薦在宗祠或歷史街區參與客家DIY（如擂茶、藍染）。",
                        "location_url": bestAttraction.map_url 
                    }
                ],
                "carbon_footprint_estimate": `${(12 - preferenceVector['LowCarbon']).toFixed(1)} kg CO2e`
            };
        }
        
        function createItineraryCard(itineraryJson) {
            let itineraryItemsHTML = '';
            itineraryJson.itinerary.forEach(item => {
                itineraryItemsHTML += `
                    <div class="py-2 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center text-sm font-semibold text-gray-700 mb-1">
                            <i data-lucide="clock" class="w-4 h-4 mr-2 text-green-600"></i>
                            ${item.time} - ${item.name}
                        </div>
                        <p class="text-xs text-gray-500 pl-6">${item.description}</p>
                        <a href="${item.location_url}" target="_blank" class="text-xs text-indigo-500 hover:text-indigo-700 transition duration-150 pl-6 underline flex items-center mt-1">
                            <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> Google 地圖
                        </a>
                    </div>
                `;
            });
            
            const cardHTML = `
                <div class="flex-card w-full max-w-sm text-gray-800">
                    <div class="p-3 bg-green-700 text-white rounded-t-xl">
                        <div class="text-xl font-bold">${itineraryJson.title}</div>
                        <div class="text-xs opacity-80 mt-1">主題: ${itineraryJson.theme}</div>
                    </div>
                    
                    <div class="p-4 space-y-3">
                        <div class="border-b pb-3">
                            <div class="text-xs font-semibold text-green-700 mb-1">小阿客推薦理由:</div>
                            <p class="text-sm">${itineraryJson.recommendation_reason}</p>
                        </div>
                        
                        <div class="text-sm font-bold mt-3">【詳細行程 - 台三線客庄】</div>
                        ${itineraryItemsHTML}

                        <div class="text-right text-xs text-indigo-500 font-medium pt-2">
                            低碳估算（參考值）: ${itineraryJson.carbon_footprint_estimate}
                        </div>
                    </div>

                    <div class="flex p-3 border-t bg-gray-50">
                        <button onclick="handlePostback('action=get_rain_plan')" class="flex-1 text-center py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold rounded-lg transition duration-200">
                            <i data-lucide="umbrella" class="w-4 h-4 inline-block mr-1"></i> 雨天備案
                        </button>
                    </div>
                </div>
            `;
            addMessage('bot', cardHTML, true);
        }
        
        // --- 圖像生成與錯誤處理 ---

        async function callImageGenerationApi(prompt) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            const payload = { 
                instances: [{ prompt: prompt }], 
                parameters: { 
                    "sampleCount": 1,
                    "outputMimeType": "image/png",
                    "aspectRatio": "1:1" // 適合聊天視窗的比例
                } 
            };

            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        return result.predictions[0].bytesBase64Encoded;
                    } else {
                        throw new Error("Image API returned no valid data.");
                    }

                } catch (error) {
                    attempts++;
                    if (attempts < maxAttempts) {
                        // Exponential backoff
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Failed to call Image Generation API after multiple retries:", error);
                        return null;
                    }
                }
            }
        }


        async function generatePersonalityImageAndMessage(finalPrefs) {
            const score = (dim) => finalPrefs[dim] || 0;

            let mainPersonality = ""; 
            let imagePromptEnglish = ""; 
            let itineraryFocus = ""; 
            let traitDescription = ""; // 新增特質描述

            // --- 新增的旅型人格判斷邏輯 ---
            
            // 1. 判斷核心維度
            const outdoorScore = score('Outdoor') - score('Indoor');
            const paceScore = score('Pace') * 0.5 - (score('CultureDepth') * 0.5 + score('RiskAversion') * 0.5); 
            const focusScore = score('CultureDepth') * 2 + score('Culture');
            
            // 2. 旅型人格分類
            
            if (focusScore > 8 && outdoorScore > 0) {
                // 高度文化深度 + 偏好戶外/探索 > 精緻探索家
                mainPersonality = "精緻探索家 (The Cultured Explorer)";
                imagePromptEnglish = "A person carefully examining a complex map near a historic Hakka temple in Taiwan, carrying a small, neat backpack. Detailed, cinematic, photo-realistic.";
                traitDescription = "您的基因：**內斂、規劃、知識享受、探索**。您重視旅程的知識性與效率，喜歡深入挖掘文化，並願意花費時間與精力去探索獨特景點。";
                itineraryFocus = "【精緻探索家】您需要結合**歷史古蹟深度導覽**與**高質量戶外體驗**。您的行程應包含明確的學習目標和高效率的移動，專注於質量而非數量。";
            } else if (outdoorScore < -4 && score('Pace') > 4) {
                // 強烈偏好室內 + 慢活步調 > 悠活度假客
                mainPersonality = "悠活度假客 (The Relaxed Retreat)";
                imagePromptEnglish = "A cozy indoor scene of a person reading a book and sipping tea in a comfortable chair by a window overlooking a misty, green Hakka village, soft ambient lighting, warm and peaceful, photograph style.";
                traitDescription = "您的基因：**隨和、悠閒、物質享受、內斂**。您追求無壓力的放鬆與舒適度，只要能讓身心放鬆，行程規劃的細節可完全交由他人處理，住宿與美食的品質對您很重要。";
                itineraryFocus = "【悠活度假客】您應選擇主打**高品質客庄旅宿**、**在地客家慢食**、**室內手作體驗**。您的旅行哲學是『慢下來，享受當下』。";
            } else if (outdoorScore > 4 && paceScore < -2) {
                // 強烈偏好戶外 + 緊湊/低Pace > 行動拓荒者
                mainPersonality = "行動拓荒者 (The Action Pioneer)";
                imagePromptEnglish = "A person standing triumphantly on a mountain peak in the Hakka region, view of rolling hills in the background, high energy, dramatic wide-angle shot, vibrant colors, photorealistic.";
                traitDescription = "您的基因：**外向、緊湊、效率、開拓**。您擁有高強度的行動力，追求在有限的時間內走訪最多的戶外景點，行程通常高效且充滿挑戰性，喜歡用雙腳丈量土地。";
                itineraryFocus = "【行動拓荒者】您需要緊湊且高強度的行程。建議行程：**挑戰型山區健行**、**長距離單車騎行**，將台三線的自然景點一網打盡，享受體能上的滿足感。";
            } else {
                // 其他均衡類型 (常伴隨高 Family/Accessibility) > 平和優遊家
                mainPersonality = "平和優遊家 (The Harmonious Wanderer)";
                imagePromptEnglish = "A family (multi-generational) walking together on a wide, accessible path in a scenic park, sunny day, focus on ease and happiness, bright and cheerful, illustration style.";
                traitDescription = "您的基因：**隨和、平衡、共享、無爭**。您希望旅程平順、舒適，樂於配合旅伴的需求。重視低風險、親子/長者友善的環境，是團隊中最好的協調者與隨行者。";
                itineraryFocus = "【平和優遊家】您適合選擇**交通便利、配套設施完善**的景點（如大型客家文化園區、易達老街），確保行程流暢且所有旅伴都能舒適參與。";
            }
            
            // 組合最終訊息 (載入前部分)
            let finalMessageContent = `
                <div class="w-full text-center p-3">
                    <div class="text-xl font-bold text-red-600 border-b-2 border-red-600 pb-2 mb-3">您的旅型人格揭曉！</div>
                    <div class="text-3xl font-extrabold text-green-700 mb-2">${mainPersonality}</div>
                    <div class="text-sm text-gray-700 font-medium mb-4">${traitDescription}</div>
                </div>
            `;
            finalMessageContent += `
                <div class="p-4 bg-gray-50 rounded-lg w-full">
                    <i data-lucide="loader" class="w-5 h-5 inline-block animate-spin mr-2 text-green-700"></i>
                    小阿客正在為您的【${mainPersonality}】旅型人格生成專屬意境圖... (約需 10-15 秒)
                </div>
            `;

            // Add the loading message to the chat and get its div
            const messageId = `msg-${Date.now()}`;
            const messageContentWrapper = addMessage('bot', `<div id="${messageId}" class="w-full">${finalMessageContent}</div>`);
            
            let imageUrl = null;
            try {
                const base64Data = await callImageGenerationApi(imagePromptEnglish);
                if (base64Data) {
                    imageUrl = `data:image/png;base64,${base64Data}`;
                }
            } catch (e) {
                console.error("Image generation failed:", e);
            }

            // 4. 替換/更新訊息內容
            let imageHtml = '';
            if (imageUrl) {
                // 修正格式跑掉的問題：確保圖片使用 w-full 且被 bot-message 良好包裹
                imageHtml = `<div class="mt-4 w-full rounded-lg shadow-xl overflow-hidden">
                                <img src="${imageUrl}" alt="AI 意境圖: ${mainPersonality}" class="w-full h-auto object-cover">
                            </div>`;
            } else {
                imageHtml = `<div class="mt-4 p-4 text-center bg-red-100 rounded-lg text-red-700 text-sm">
                                意境圖生成失敗，請稍後再試。
                            </div>`;
            }

            // Final message content with image
            let finalMessageWithImage = `
                <div class="p-3 w-full">
                    <div class="text-xl font-bold text-red-600 border-b-2 border-red-600 pb-2 mb-3 text-center">您的旅型人格揭曉！</div>
                    <div class="text-3xl font-extrabold text-green-700 mb-2 text-center">${mainPersonality}</div>
                    <div class="text-sm text-gray-700 font-medium mb-4 text-center">${traitDescription}</div>
                    
                    ${imageHtml}
                    
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <div class="text-sm font-semibold text-green-700 mb-1">小阿客的客製化行程建議：</div>
                        <p class="text-sm text-gray-600">${itineraryFocus}</p>
                        <p class="mt-3 text-xs text-indigo-500">現在請直接輸入您的旅遊需求 (例如：『新竹峨眉，戶外活動』 或 『想去苗栗南庄，慢活主題』)，小阿客會立即為您規劃**最客製化**的台三線客庄行程！</p>
                    </div>
                </div>
            `;


            // Update the content of the existing message wrapper
            if (messageContentWrapper) {
                messageContentWrapper.classList.add('p-0'); // 移除外層 padding，讓內層自訂
                messageContentWrapper.innerHTML = finalMessageWithImage;
                lucide.createIcons(); // Re-render icons after content change
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }


        // --- 事件處理 (保持不變) ---

        async function handlePostback(data) {
            const params = new URLSearchParams(data);
            const action = params.get('action');
            const userState = getUserState(DEFAULT_USER_ID);

            if (action === 'next_quiz') {
                const nextStep = parseInt(params.get('step'));
                const valString = params.get('val');
                
                // 1. 累積權重
                updatePreferenceVector(DEFAULT_USER_ID, valString);
                userState.quiz_step = nextStep - 1; 

                if (nextStep <= TOTAL_QUIZ_STEPS) {
                    // 2. 發送下一題
                    const quizData = QUIZ_QUESTIONS[nextStep];
                    createQuizMessage(quizData, nextStep);
                    userState.quiz_step = nextStep;
                } else {
                    // 3. 測驗結束 (輸出浪漫化的總結 + 圖像生成)
                    userState.quiz_step = TOTAL_QUIZ_STEPS;
                    const finalPrefs = userState.preferences;
                    
                    await generatePersonalityImageAndMessage(finalPrefs);
                }

            } else if (action === 'get_rain_plan') {
                // 模擬雨天備案的互動
                addMessage('bot', '好的，小阿客收到雨天備案請求！若遇下雨，建議將戶外步道改為參觀附近的**客家文化會館**或**室內DIY體驗**（如米食製作）。');
            }
        }

        /**
         * 處理用戶在 Rich Menu 或文字輸入框的指令
         * @param {string} text - 用戶輸入或點擊的指令文字
         */
        function handleMessage(text) {
            const userState = getUserState(DEFAULT_USER_ID);
            
            // 模擬用戶發送訊息
            addMessage('user', text);

            const isRestart = text === "重新測驗" || text === "開始問卷";
            
            // --- 修正 BUG: 確保點擊 '重新測驗' 時能正確啟動測驗 ---
            
            if (isRestart) {
                // 1. 重設狀態
                userState.quiz_step = 0;
                userState.preferences = { ...PREFERENCE_DIMENSIONS };
            }

            // Check if quiz needs to be started (step is 0)
            if (userState.quiz_step === 0) {
                // 讓用戶知道需要先測驗
                if (text.includes('規劃行程') && !isRestart) {
                    addMessage('bot', "小阿客了解您的需求！請先點擊「開始問卷」按鈕，完成 **10 題客庄旅遊問卷**，以獲得最客製化的行程建議。");
                    return; // 提示後不立即啟動，讓用戶自行點擊
                } else if (!isRestart && !text.includes('規劃行程')) {
                    // 如果用戶輸入隨意文字，提示他們開始測驗
                    addMessage('bot', "請先點擊「開始問卷」按鈕，啟動客製化流程。");
                    return;
                }
                
                // 2. 啟動測驗 (Q1)
                const quizData = QUIZ_QUESTIONS[1];
                createQuizMessage(quizData, 1);
                userState.quiz_step = 1;
                return;
            }
            // --- 修正結束 ---


            // 處理行程規劃需求 (需要先完成測驗)
            if (userState.quiz_step >= TOTAL_QUIZ_STEPS || text.includes('規劃行程') || text.includes('行程')) {
                try {
                    addMessage('bot', `<i data-lucide="loader" class="w-4 h-4 mr-1 inline-block animate-spin text-green-700"></i> 小阿客正在根據您的旅型人格和「${text}」規劃**台三線客庄行程**中... 請稍候。`);
                    
                    // 模擬 1.5 秒延遲來模擬 LLM 呼叫時間
                    setTimeout(() => {
                        const preferenceVector = userState.preferences;
                        // 使用新的 LLM 函數，該函數會結合真實景點資料庫進行規劃
                        const itineraryJson = generateHakkaItinerary(text, preferenceVector);
                        createItineraryCard(itineraryJson);
                    }, 1500);

                } catch (e) {
                    addMessage('bot', `對不起，行程規劃系統出現錯誤: ${e.message}`);
                    console.error("行程規劃錯誤:", e);
                }
            } else if (userState.quiz_step > 0 && userState.quiz_step < TOTAL_QUIZ_STEPS) {
                // 用戶正在測驗中，但輸入了其他文字
                 addMessage('bot', `請先回答目前的第 ${userState.quiz_step} 題，才能繼續喔！`);
            }
        }

        function sendMessage() {
            const text = userInput.value.trim();
            if (text) {
                handleMessage(text);
                userInput.value = ''; // 清空輸入框
            }
        }

        // --- 網頁載入初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 初始問候語
            addMessage('bot', `您好，我是您的客途 AI 旅伴 — **小阿客**！<br>
                                我們將探索台三線（浪漫客庄大道）的獨特魅力。<br>
                                為了給您最貼心的行程建議，請先完成 **10 題客庄旅遊問卷**。`);
            
            // 延遲後顯示開始按鈕 (模擬 Rich Menu 互動)
            setTimeout(() => {
                const quizStartButton = `
                    <div class="w-full text-center">
                        <button onclick="handleMessage('重新測驗')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200 shadow-md">
                            點我開始問卷！
                        </button>
                    </div>
                `;
                addMessage('bot', quizStartButton, true);
            }, 500);
        });

    </script>
</body>
</html>
